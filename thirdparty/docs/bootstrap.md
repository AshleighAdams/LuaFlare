# Bootstrapping

LuaFlare provides it's own flavour of Lua,
coming with type-checking and default values for function arguments.
To upgrade the current Lua state, some bootstrapping must be done first.

## Syntax Extensions

LuaFlare provides some type-checking syntax.  Before loading any code, either by `require()`, `dofile()`, or `include()`, LuaFlare will process the file, and translate the type information to an immediate call to `expects()`.

#### type arg `function(type arg)`

Tests `arg` against `"type"`.

#### :: `function meta::func()`

Test `self` against `meta`.

#### meta& arg `function(meta& arg)`

Tests `arg` against `meta`.

#### arg=default `function(msg="hello")`

Set `arg` to `default` if `arg == nil` (placed before `expects()`).

### How `expects()` works

`expects()` will examine the stack, and compare it with the arguments that have been passed to it.

If the type passed type is a string, it will check it against the function `expects_types[typestr](value)` if it exists, else `type(value) == typestr`.  The type string `"any"` will just check against a non-nil value.

If the passed type is nil, it will ignore this argument.

If the passed type is a table, it will ensure the value table contains the same functions (via `metatable_compatible()`).

`expects()` also checks against too many arguments being passed to it.  So this will throw an error: `function(a) expects("string", "number")`

### Examples, along with translations

#### Standard

`function(string a, number b)`

`function(a, b) expects("string", "number")`

#### `self` checking.

`function meta::func()`

`function meta:func() expects(meta)`

#### Metatable

`function(meta& a)`

`function(a) expects(meta)`

#### Complex

`function meta::dosomething(string arg, meta& other, string message = "hello")`

`function meta:dosomething(arg, other, message) if message == nil then message = "hello" end expects(meta, "string", meta, "string")`

## Bootstrap table

The bootstrap table contains a number of functions that may be used early in the
LuaFlare boot process.

### `bootstrap.pack(...)`

The same as `table.pack`, but guaranteed to be there.

### `bootstrap.unpack(...)`

The same as `table.unpack`, but guaranteed to be there.

### `bootstrap.options`

The options table that was passed when initializing the bootstrap process.

### `bootstrap.log_buffer`

The log output generated by the bootstrap process.

### `bootstrap.log_depth`

The current depth of the log (indentation).

### `bootstrap.log_deeper()`

Increase the log depth.

### `bootstrap.log_shallower()`

Decrease the log depth.

### `bootstrap.log(string format, ...)`

Output logging information.

### `bootstrap.fatal(string format, ...)`

Called upon an unrecoverable error, or a state that results in bootstrapping failing.

### `bootstrap.loadfile(string path, ...)`

Load the file `path` in the "bootstrap/" directory.

### `bootstrap.module(string name, string path)`

Loads a module from `path` and installs it as `name`.

Future calls to require(`name`) will return `path`'s return value.

### `bootstrap.extend(string name, string path)`

Installs some functions/variables into the table `_G[name]`, with what `path` returns.

### `bootstrap.level_string`

A human-readable version of `level_cache`.

### `bootstrap.level_cache`

A table in the format of `[lvl] = true` where `lvl` is a name of a level.
Used to ensure the right extensions are available.

### `bootstrap.level(string name)`

If the level `name` has not been reached, error and exit.

### `bootstrap.set_level(string name)`

Report that the level `name` has been reached.

## Bootstrap Process

1. Ensure compatibility with old versions of Lua.
1. Install all the modules required by the extensions and/or translator.
	1. Install `hook.lua` into `luaflare.hook`.
	1. Install `stringreader.lua` into `luaflare.util.luaparser.stringreader`.
	1. Install `luaparser.lua` into `luaflare.util.luaparser`.
	1. Install `stack.lua` into `luaflare.util.stack`.
1. Extend Lua's default libraries.
	1. Install global type checking functions.
	1. Extend `string`.
	1. Extend `table`.
	1. Extend `math`.
	1. Extend `os`.
1. Setup the translator.
	1. Install `translate-luacode.lua` into `luaflare.util.translate_luacode`.
	1. Detour functions that need a translator (i.e. `require()`), and install `include()`.
1. Ensure forwards Lua compatibility.
1. Ensure backwards compatibility with old versions of LuaFlare.
1. Set the process name.

## Automatic Circular Requires

Very often, a module may have a circular dependency,
such as module "a" requires "b", and module "b" requires "a".
In C/C++, such dependencies are resolved by using header guards.
Such a system is not compatible with Lua as there is no such thing as a definition.
Often, providing a reference to the table that is yet to be populated is enough,
as the require-er does not need to use the library right away.

In standard Lua, an early reference that subsequent requires will return is set
by filling in the `package.loaded` field for your module.

The module name is passed as the first argument, so you may fill in the package.loaded field via the following code:

	local mod_name = {}
	package.loaded[...] = mod_name

When doing this, the `return mod_name` at the end of the file is no longer necessary,
but is kept for semantic purposes.

The bootstrap's require will automatically detect modules where the first (meaningful) tokens are defining an empty table,
*and* the file's last tokens are returning the same table,
then a reference right after the table has been created is installed into the package.loaded table.
This allows, for 99% of cases for circular requires to be resolved.

This works because nearly all modules will only use the required modules after they've *returned* from the main function.
In other words, the main 'file function' only populates the module table, loads & saves references to other modules,
and then returns.  The actual modules needed are often only called once everything has been populated.
For these reasons, it is discouraged to use the 'population' function as a means to do work.  If you need to do work on load,
please use the hook named "Load", which will be called after LuaFlare is started up.

![Circular require in Lua](images/non-bootstrapped-acr.png)

![Circular require in bootstrapped Lua](images/bootstrapped-acr.png)
